---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";
import "../styles/search.css";

const session = Astro.locals.session;
const user = Astro.locals.user;

if (!session || !user) {
  return Astro.redirect("/login");
}

const query = Astro.url.searchParams.get("q") || "";

let searchResults = [];

if (query) {
  const { data } = await supabase
    .from("profiles")
    .select("*")
    .or(`username.ilike.%${query}%,full_name.ilike.%${query}%`)
    .limit(10);

  searchResults = data || [];
}
---

<Layout title={`Find: ${query}`}>
  <div class="search-page">
    <main class="search-main">
      <div class="search-container">
        {
          query && (
            <div class="search-results">
              <h2>Results for "{query}"</h2>

              {searchResults.length > 0 ? (
                <div class="users-list">
                  {searchResults.map((user) => (
                    <a href={`/users/${user.username}`} class="user-card">
                      <img
                        src={user.avatar_url || "/images/default-avatar.jpg"}
                        alt={user.username}
                        class="user-avatar"
                      />
                      <div class="user-info">
                        <h3>@{user.username}</h3>
                        <p class="user-fullname">{user.full_name}</p>
                        {user.bio && <p class="user-bio">{user.bio}</p>}
                      </div>
                    </a>
                  ))}
                </div>
              ) : (
                <div class="no-results">
                  <p>No users were found for "{query}"</p>
                </div>
              )}
            </div>
          )
        }
      </div>
    </main>
  </div>
</Layout>
