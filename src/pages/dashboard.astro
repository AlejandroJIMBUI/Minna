---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";
import "../styles/dashboard.css";

const session = Astro.locals.session;
const user = Astro.locals.user;

if (!session || !user) {
  return Astro.redirect("/login");
}

const { data: posts } = await supabase
  .from("posts")
  .select("*")
  .order("created_at", { ascending: false })
  .limit(20);

let postsWithProfiles = [];

if (posts && posts.length > 0) {
  const userIds = [...new Set(posts.map((post) => post.user_id))];
  const { data: profiles } = await supabase
    .from("profiles")
    .select("id, username, full_name")
    .in("id", userIds);

  postsWithProfiles = posts.map((post) => {
    const profile = profiles?.find((p) => p.id === post.user_id);
    return {
      ...post,
      profiles: profile || { username: "Usuario", full_name: "Usuario" },
    };
  });
}
---

<Layout title="Dashboard">
  <div class="dashboard">
    <main class="dashboard-main">
      <div class="create-post-cta">
        <h2>Welcome to your Dashboard</h2>
        <p>Share your thoughts with the community</p>
        <a href="/create-post" class="create-post-btn"> Create New Post </a>
      </div>

      <div class="posts-feed">
        <h3>Recent Publications</h3>

        {
          postsWithProfiles && postsWithProfiles.length > 0 ? (
            <div class="posts-list">
              {postsWithProfiles.map((post) => (
                <article class="post-card">
                  <div class="post-header">
                    <span class="post-author">
                      <a
                        href={`/users/${post.profiles.username}`}
                        class="username-link"
                      >
                        @{post.profiles.username}
                      </a>
                    </span>
                    <span class="post-date">
                      {new Date(post.created_at).toLocaleDateString()}
                    </span>
                  </div>
                  <h4 class="post-title">{post.title}</h4>
                  <p class="post-content">{post.content}</p>
                  {post.media_url && (
                    <div class="post-media">
                      <img
                        src={post.media_url}
                        alt="Media"
                        class="post-image"
                      />
                    </div>
                  )}
                </article>
              ))}
            </div>
          ) : (
            <div class="no-posts">
              <p>There are no posts yet. Be the first to post!</p>
              <a href="/create-post" class="create-post-link">
                Create first post
              </a>
            </div>
          )
        }
      </div>
    </main>
  </div>
</Layout>
