---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";
import "../styles/profile.css";

const session = Astro.locals.session;
const user = Astro.locals.user;

if (!session || !user) {
  return Astro.redirect("/login");
}

const { data: profile } = await supabase
  .from("profiles")
  .select("*")
  .eq("id", user.id)
  .single();

const { data: userPosts } = await supabase
  .from("posts")
  .select("*")
  .eq("user_id", user.id)
  .order("created_at", { ascending: false });

const error = Astro.url.searchParams.get("error");
const message = Astro.url.searchParams.get("message");
---

<Layout title="My Profile">
  <div class="profile-page">
    <main class="profile-main">
      <div class="profile-card">
        {
          Astro.url.searchParams.get("from") !== "profile" && error && (
            <div class="error-message">{decodeURIComponent(error)}</div>
          )
        }
        {
          Astro.url.searchParams.get("from") !== "profile" && message && (
            <div class="success-message">{decodeURIComponent(message)}</div>
          )
        }

        <div class="profile-header-section">
          <div class="avatar-section">
            <img
              src={profile?.avatar_url || "/images/default-avatar.jpg"}
              alt="Avatar"
              class="profile-avatar"
              id="avatarPreview"
            />
          </div>
          <div class="profile-info">
            <h1>@{profile?.username}</h1>
            <p class="full-name">{profile?.full_name}</p>
            <div class="profile-actions">
              <button class="edit-profile-btn" id="editProfileBtn">
                Edit Profile
              </button>
              <form method="POST" action="/api/auth/logout" class="logout-form">
                <button type="submit" class="logout-btn">Logout</button>
              </form>
            </div>
          </div>
        </div>

        {
          profile?.bio && (
            <div class="bio-section">
              <h3>Biography</h3>
              <p class="bio-text">{profile.bio}</p>
            </div>
          )
        }

        <div class="profile-stats">
          <span class="stat">
            <strong>{userPosts?.length || 0}</strong> publications
          </span>
          <span class="stat">
            Member since {
              new Date(profile?.created_at || new Date()).getFullYear()
            }
          </span>
        </div>

        <form
          method="POST"
          action="/api/profile/update"
          class="profile-form"
          id="editForm"
          style="display: none;"
        >
          {
            Astro.url.searchParams.get("from") === "profile" && error && (
              <div class="error-message">{decodeURIComponent(error)}</div>
            )
          }
          {
            Astro.url.searchParams.get("from") === "profile" && message && (
              <div class="success-message">{decodeURIComponent(message)}</div>
            )
          }

          <div class="form-group">
            <label>Profile photo</label>
            <div class="avatar-edit-section">
              <img
                src={profile?.avatar_url || "/images/default-avatar.jpg"}
                alt="Avatar"
                class="profile-avatar-edit"
                id="avatarPreviewEdit"
              />
              <div class="avatar-upload-edit">
                <div class="avatar-upload-form">
                  <label for="avatarInput" class="avatar-upload-label">
                    Change photo
                  </label>
                  <input
                    type="file"
                    id="avatarInput"
                    accept="image/*"
                    style="display: none;"
                  />
                  <div class="upload-info" id="uploadInfo">
                    Máx. 1MB - JPG, PNG, GIF
                  </div>

                  {
                    profile?.avatar_url && (
                      <button
                        type="button"
                        class="delete-avatar-btn"
                        id="deleteAvatarBtn"
                      >
                        Delete photo
                      </button>
                    )
                  }
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="username">Username</label>
            <input
              type="text"
              id="username"
              name="username"
              value={profile?.username || ""}
              required
              placeholder="ur_user"
            />
          </div>

          <div class="form-group">
            <label for="fullName">Full name</label>
            <input
              type="text"
              id="fullName"
              name="fullName"
              value={profile?.full_name || ""}
              required
              placeholder="your full name"
            />
          </div>

          <div class="form-group">
            <label for="bio">Biography</label>
            <textarea id="bio" name="bio" placeholder="talk about you" rows="4"
              >{profile?.bio || ""}</textarea
            >
          </div>

          <div class="form-actions">
            <button type="button" class="cancel-btn" id="cancelEditBtn">
              Cancel
            </button>
            <button type="submit" class="save-btn">Save</button>
          </div>
        </form>
      </div>

      <div class="user-posts">
        <h2>My Publications</h2>

        {
          userPosts && userPosts.length > 0 ? (
            <div class="posts-list">
              {userPosts.map((post) => (
                <article class="post-card" id={`post-${post.id}`}>
                  <div class="post-actions">
                    <form
                      method="POST"
                      action="/api/posts/delete"
                      class="delete-post-form"
                      id={`deleteForm-${post.id}`}
                    >
                      <input type="hidden" name="postId" value={post.id} />
                      <button
                        type="submit"
                        class="delete-post-btn"
                        title="Delete post"
                      >
                        ×
                      </button>
                    </form>
                  </div>

                  <div class="post-header">
                    <span class="post-date">
                      {new Date(post.created_at).toLocaleDateString()}
                    </span>
                  </div>
                  <h3 class="post-title">{post.title}</h3>
                  <p class="post-content">{post.content}</p>
                </article>
              ))}
            </div>
          ) : (
            <div class="no-posts">
              <p>You haven't created any posts yet.</p>
              <a href="/create-post" class="create-post-link">
                Create first post
              </a>
            </div>
          )
        }
      </div>
    </main>
  </div>

  <script is:inline>
    document.addEventListener("DOMContentLoaded", function () {
      function toggleEditForm() {
        const form = document.getElementById("editForm");
        if (form) {
          const isHidden = form.style.display === "none";
          form.style.display = isHidden ? "block" : "none";

          const editButton = document.getElementById("editProfileBtn");
          if (editButton) {
            editButton.textContent = isHidden
              ? "Cancel Edition"
              : "Edit Profile";
          }
        }
      }

      const editProfileBtn = document.getElementById("editProfileBtn");
      const cancelEditBtn = document.getElementById("cancelEditBtn");

      if (editProfileBtn) {
        editProfileBtn.addEventListener("click", toggleEditForm);
      }

      if (cancelEditBtn) {
        cancelEditBtn.addEventListener("click", toggleEditForm);
      }

      async function deleteAvatar() {
        const uploadInfo = document.getElementById("uploadInfo");

        if (!confirm("Are you sure you want to delete your profile picture?")) {
          return;
        }

        try {
          uploadInfo.textContent = "Deleting...";
          uploadInfo.style.color = "#5f6ee7";

          const response = await fetch("/api/profile/delete-avatar", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error);
          }

          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } catch (error) {
          console.error("Error deleting avatar:", error);
          uploadInfo.textContent = "Error: " + error.message;
          uploadInfo.style.color = "#ff4500";
        }
      }

      const deleteAvatarBtn = document.getElementById("deleteAvatarBtn");
      if (deleteAvatarBtn) {
        deleteAvatarBtn.addEventListener("click", deleteAvatar);
      }

      function confirmDelete(form) {
        const result = confirm(
          "Are you sure you want to delete this post? This action cannot be undone."
        );
        if (result) {
          const deleteBtn = form.querySelector(".delete-post-btn");
          if (deleteBtn) {
            deleteBtn.textContent = "...";
            deleteBtn.disabled = true;
          }
        }
        return result;
      }

      const deleteForms = document.querySelectorAll(".delete-post-form");
      deleteForms.forEach((form) => {
        form.addEventListener("submit", function (e) {
          if (!confirmDelete(this)) {
            e.preventDefault();
          }
        });
      });

      const avatarInput = document.getElementById("avatarInput");
      const uploadInfo = document.getElementById("uploadInfo");

      if (avatarInput && uploadInfo) {
        avatarInput.addEventListener("change", async function (event) {
          const file = event.target.files[0];

          if (!file) return;

          // Validar tamaño (1MB = 1,048,576 bytes)
          if (file.size > 1048576) {
            uploadInfo.textContent =
              "Error: The image must be smaller than 1MB";
            uploadInfo.style.color = "#ff4500";
            return;
          }

          // Validar tipo de archivo
          if (!file.type.startsWith("image/")) {
            uploadInfo.textContent = "Error: Only images are allowed";
            uploadInfo.style.color = "#ff4500";
            return;
          }

          try {
            uploadInfo.textContent = "Uploading...";
            uploadInfo.style.color = "#5f6ee7";

            const formData = new FormData();
            formData.append("avatar", file);

            const response = await fetch("/api/profile/upload-avatar", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (!response.ok) {
              throw new Error(result.error);
            }

            setTimeout(() => {
              window.location.reload();
            }, 1000);
          } catch (error) {
            console.error("Error uploading avatar:", error);
            uploadInfo.textContent = "Error: " + error.message;
            uploadInfo.style.color = "#ff4500";
          }
        });
      }

      const urlParams = new URLSearchParams(window.location.search);
      const message = urlParams.get("message");
      const error = urlParams.get("error");

      if (message || error) {
        window.scrollTo(0, 0);
      }
    });
  </script>
</Layout>
