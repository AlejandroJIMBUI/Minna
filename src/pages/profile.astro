---
export const prerender = false;
import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";

const session = Astro.locals.session;
const user = Astro.locals.user;

if (!session || !user) {
  return Astro.redirect("/login");
}

// Obtener perfil del usuario
const { data: profile } = await supabase
  .from("profiles")
  .select("*")
  .eq("id", user.id)
  .single();

// Obtener publicaciones del usuario
const { data: userPosts } = await supabase
  .from("posts")
  .select("*")
  .eq("user_id", user.id)
  .order("created_at", { ascending: false });

const error = Astro.url.searchParams.get("error");
const message = Astro.url.searchParams.get("message");
---

<Layout title="Mi Perfil">
  <div class="profile-page">
    <main class="profile-main">
      <div class="profile-card">
        <div class="profile-header-section">
          <div class="avatar-section">
            <img
              src={profile?.avatar_url || "/images/default-avatar.jpg"}
              alt="Avatar"
              class="profile-avatar"
              id="avatarPreview"
            />
          </div>
          <div class="profile-info">
            <h1>@{profile?.username}</h1>
            <p class="full-name">{profile?.full_name}</p>
            <div class="profile-actions">
              <button class="edit-profile-btn" onclick="toggleEditForm()">
                Editar Perfil
              </button>
              <form method="POST" action="/api/auth/logout" class="logout-form">
                <button type="submit" class="logout-btn">Cerrar Sesión</button>
              </form>
            </div>
          </div>
        </div>

        {
          profile?.bio && (
            <div class="bio-section">
              <h3>Biografía</h3>
              <p class="bio-text">{profile.bio}</p>
            </div>
          )
        }

        <div class="profile-stats">
          <span class="stat">
            <strong>{userPosts?.length || 0}</strong> publicaciones
          </span>
          <span class="stat">
            Miembro desde {
              new Date(profile?.created_at || new Date()).getFullYear()
            }
          </span>
        </div>

        <!-- Formulario de edición (oculto por defecto) -->
        <form
          method="POST"
          action="/api/profile/update"
          class="profile-form"
          id="editForm"
          style="display: none;"
        >
          {
            error && (
              <div class="error-message">{decodeURIComponent(error)}</div>
            )
          }
          {
            message && (
              <div class="success-message">{decodeURIComponent(message)}</div>
            )
          }

          <!-- Sección de avatar SOLO visible en modo edición -->
          <div class="form-group">
            <label>Foto de perfil</label>
            <div class="avatar-edit-section">
              <img
                src={profile?.avatar_url || "/default-avatar.jpg"}
                alt="Avatar"
                class="profile-avatar-edit"
                id="avatarPreviewEdit"
              />
              <div class="avatar-upload-edit">
                <div class="avatar-upload-form">
                  <label for="avatarInput" class="avatar-upload-label">
                    Cambiar foto
                  </label>
                  <input
                    type="file"
                    id="avatarInput"
                    accept="image/*"
                    style="display: none;"
                  />
                  <div class="upload-info" id="uploadInfo">
                    Máx. 1MB - JPG, PNG, GIF
                  </div>

                  <!-- Botón para eliminar foto -->
                  {
                    profile?.avatar_url && (
                      <button
                        type="button"
                        class="delete-avatar-btn"
                        onclick="deleteAvatar()"
                      >
                        Eliminar foto
                      </button>
                    )
                  }
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="username">Nombre de usuario</label>
            <input
              type="text"
              id="username"
              name="username"
              value={profile?.username || ""}
              required
              placeholder="tu_usuario"
            />
          </div>

          <div class="form-group">
            <label for="fullName">Nombre completo</label>
            <input
              type="text"
              id="fullName"
              name="fullName"
              value={profile?.full_name || ""}
              required
              placeholder="Tu nombre completo"
            />
          </div>

          <div class="form-group">
            <label for="bio">Biografía</label>
            <textarea
              id="bio"
              name="bio"
              placeholder="Cuéntanos sobre ti..."
              rows="4">{profile?.bio || ""}</textarea
            >
          </div>

          <div class="form-actions">
            <button type="button" class="cancel-btn" onclick="toggleEditForm()">
              Cancelar
            </button>
            <button type="submit" class="save-btn">Guardar Cambios</button>
          </div>
        </form>
      </div>

      <div class="user-posts">
        <h2>Mis Publicaciones ({userPosts?.length || 0})</h2>

        {
          userPosts && userPosts.length > 0 ? (
            <div class="posts-list">
              {userPosts.map((post) => (
                <article class="post-card">
                  <div class="post-header">
                    <span class="post-date">
                      {new Date(post.created_at).toLocaleDateString()}
                    </span>
                  </div>
                  <h3 class="post-title">{post.title}</h3>
                  <p class="post-content">{post.content}</p>
                </article>
              ))}
            </div>
          ) : (
            <div class="no-posts">
              <p>Aún no has creado publicaciones.</p>
              <a href="/create-post" class="create-post-link">
                Crear primera publicación
              </a>
            </div>
          )
        }
      </div>
    </main>
  </div>

  <script is:inline>
    function toggleEditForm() {
      const form = document.getElementById("editForm");
      if (form) {
        const isHidden = form.style.display === "none";
        form.style.display = isHidden ? "block" : "none";

        // Cambiar el texto del botón
        const editButton = document.querySelector(".edit-profile-btn");
        if (editButton) {
          editButton.textContent = isHidden
            ? "Cancelar Edición"
            : "Editar Perfil";
        }
      }
    }

    // Función para eliminar avatar
    async function deleteAvatar() {
      const avatarPreview = document.getElementById("avatarPreview");
      const avatarPreviewEdit = document.getElementById("avatarPreviewEdit");
      const uploadInfo = document.getElementById("uploadInfo");

      if (
        !confirm("¿Estás seguro de que quieres eliminar tu foto de perfil?")
      ) {
        return;
      }

      try {
        uploadInfo.textContent = "Eliminando...";
        uploadInfo.style.color = "#5f6ee7";

        const response = await fetch("/api/profile/delete-avatar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error);
        }

        // Forzar recarga de la página para asegurar que los cambios se reflejen
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } catch (error) {
        console.error("Error eliminando avatar:", error);
        uploadInfo.textContent = "Error: " + error.message;
        uploadInfo.style.color = "#ff4500";
      }
    }

    // Upload de avatar usando API endpoint
    document.addEventListener("DOMContentLoaded", function () {
      const avatarInput = document.getElementById("avatarInput");
      const avatarPreview = document.getElementById("avatarPreview");
      const avatarPreviewEdit = document.getElementById("avatarPreviewEdit");
      const uploadInfo = document.getElementById("uploadInfo");

      avatarInput.addEventListener("change", async function (event) {
        const file = event.target.files[0];

        if (!file) return;

        // Validar tamaño (1MB = 1,048,576 bytes)
        if (file.size > 1048576) {
          uploadInfo.textContent = "Error: La imagen debe ser menor a 1MB";
          uploadInfo.style.color = "#ff4500";
          return;
        }

        // Validar tipo de archivo
        if (!file.type.startsWith("image/")) {
          uploadInfo.textContent = "Error: Solo se permiten imágenes";
          uploadInfo.style.color = "#ff4500";
          return;
        }

        try {
          uploadInfo.textContent = "Subiendo...";
          uploadInfo.style.color = "#5f6ee7";

          const formData = new FormData();
          formData.append("avatar", file);

          const response = await fetch("/api/profile/upload-avatar", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error);
          }

          // Forzar recarga de la página para asegurar que los cambios se reflejen
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } catch (error) {
          console.error("Error subiendo avatar:", error);
          uploadInfo.textContent = "Error: " + error.message;
          uploadInfo.style.color = "#ff4500";
        }
      });
    });
  </script>
</Layout>

<style>
  .profile-page {
    min-height: 100vh;
    background: #f5f5f5;
  }

  .profile-main {
    padding: 2rem;
    max-width: 800px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .profile-card {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-top: 2rem;
  }

  .profile-header-section {
    display: flex;
    gap: 2rem;
    align-items: flex-start;
    margin-bottom: 2rem;
  }

  .avatar-section {
    flex-shrink: 0;
    text-align: center;
  }

  .profile-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #5f6ee7;
  }

  .profile-info {
    flex: 1;
  }

  .profile-info h1 {
    margin: 0 0 0.5rem 0;
    color: #333;
  }

  .full-name {
    margin: 0 0 1rem 0;
    color: #666;
    font-size: 1.1rem;
  }

  .profile-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .edit-profile-btn {
    padding: 0.5rem 1rem;
    background: #5f6ee7;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  .logout-form {
    margin: 0;
  }

  .logout-btn {
    padding: 0.5rem 1rem;
    background: #ff4500;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  .bio-section {
    margin-bottom: 1.5rem;
  }

  .bio-section h3 {
    margin: 0 0 0.5rem 0;
    color: #333;
  }

  .bio-text {
    margin: 0;
    color: #555;
    line-height: 1.5;
  }

  .profile-stats {
    display: flex;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .stat {
    color: #666;
  }

  .stat strong {
    color: #333;
  }

  .profile-form {
    border-top: 1px solid #eee;
    padding-top: 2rem;
  }

  /* Estilos para la sección de avatar en edición */
  .avatar-edit-section {
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
  }

  .profile-avatar-edit {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid #5f6ee7;
  }

  .avatar-upload-edit {
    flex: 1;
  }

  .avatar-upload-form {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .avatar-upload-label {
    padding: 0.5rem 1rem;
    background: #f0f0f0;
    color: #333;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.2s;
    text-align: center;
    width: fit-content;
  }

  .avatar-upload-label:hover {
    background: #e0e0e0;
  }

  .upload-info {
    font-size: 0.8rem;
    color: #666;
  }

  /* Estilos para el botón de eliminar avatar */
  .delete-avatar-btn {
    padding: 0.4rem 0.8rem;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    margin-top: 0.5rem;
    transition: background-color 0.2s;
    width: fit-content;
  }

  .delete-avatar-btn:hover {
    background: #c82333;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1.5rem;
  }

  .form-group label {
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #333;
  }

  .form-group input,
  .form-group textarea {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    font-family: inherit;
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
  }

  .save-btn {
    padding: 0.75rem 1.5rem;
    background: #5f6ee7;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
  }

  .cancel-btn {
    padding: 0.75rem 1.5rem;
    background: #666;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
  }

  .user-posts {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .posts-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-top: 1.5rem;
  }

  .post-card {
    padding: 1.5rem;
    border: 1px solid #eee;
    border-radius: 8px;
    background: #fafafa;
  }

  .post-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: #666;
  }

  .post-title {
    margin: 0 0 1rem 0;
    color: #333;
    font-size: 1.2rem;
  }

  .post-content {
    margin: 0;
    color: #555;
    line-height: 1.5;
  }

  .no-posts {
    text-align: center;
    padding: 2rem;
    color: #666;
  }

  .create-post-link {
    color: #5f6ee7;
    text-decoration: none;
  }

  .error-message {
    background: #fee;
    color: #c33;
    padding: 0.75rem;
    border-radius: 4px;
    border: 1px solid #fcc;
    margin-bottom: 1rem;
  }

  .success-message {
    background: #efe;
    color: #363;
    padding: 0.75rem;
    border-radius: 4px;
    border: 1px solid #cfc;
    margin-bottom: 1rem;
  }
</style>
